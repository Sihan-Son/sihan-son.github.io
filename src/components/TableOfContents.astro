---
interface Props {
  headings: { depth: number; slug: string; text: string }[];
}

const { headings } = Astro.props;
const filtered = headings.filter(h => h.depth === 2 || h.depth === 3);
---

{filtered.length > 0 && (
  <nav id="toc" class="hidden xl:block fixed left-8 top-24 w-48 z-40">
    <p class="font-mono text-xs tracking-wider uppercase mb-3" style="color: var(--text-muted);">
      목차
    </p>
    <ul class="space-y-1.5">
      {filtered.map(h => (
        <li>
          <a
            href={`#${h.slug}`}
            class:list={[
              'toc-link block font-mono text-xs leading-snug transition-colors duration-200 border-l-2 border-transparent',
              h.depth === 3 ? 'pl-5' : 'pl-3',
            ]}
            style="color: var(--text-muted);"
            data-slug={h.slug}
          >
            {h.text}
          </a>
        </li>
      ))}
    </ul>
  </nav>
)}

<script>
  function initTOC() {
    const links = document.querySelectorAll<HTMLAnchorElement>('.toc-link');
    if (links.length === 0) return;

    const slugs = Array.from(links).map(l => l.dataset.slug!);
    let activeSlug = '';

    function setActive(slug: string) {
      if (slug === activeSlug) return;
      activeSlug = slug;
      links.forEach(link => {
        const isActive = link.dataset.slug === slug;
        link.style.color = isActive ? 'var(--accent)' : 'var(--text-muted)';
        link.style.borderLeftColor = isActive ? 'var(--accent)' : 'transparent';
        link.style.fontWeight = isActive ? '500' : '400';
      });
    }

    const observer = new IntersectionObserver(
      (entries) => {
        // Find the topmost visible heading
        const visible = entries
          .filter(e => e.isIntersecting)
          .sort((a, b) => a.boundingClientRect.top - b.boundingClientRect.top);

        if (visible.length > 0) {
          setActive(visible[0].target.id);
        }
      },
      { rootMargin: '-80px 0px -60% 0px', threshold: 0 }
    );

    slugs.forEach(slug => {
      const el = document.getElementById(slug);
      if (el) observer.observe(el);
    });

    // Set initial active based on scroll position
    const scrollY = window.scrollY;
    let closest = slugs[0];
    for (const slug of slugs) {
      const el = document.getElementById(slug);
      if (el && el.getBoundingClientRect().top + scrollY - 100 <= scrollY) {
        closest = slug;
      }
    }
    setActive(closest);
  }

  // Run on initial load and on Astro page transitions
  initTOC();
  document.addEventListener('astro:after-swap', initTOC);
</script>
