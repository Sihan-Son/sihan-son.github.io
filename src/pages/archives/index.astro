---
import { getCollection } from 'astro:content';
import BaseLayout from '../../layouts/BaseLayout.astro';
import { getPostSlug } from '../../lib/constants';

const allPosts = (await getCollection('posts'))
  .filter(p => import.meta.env.DEV || !p.data.draft)
  .sort((a, b) => b.data.date.valueOf() - a.data.date.valueOf());

const postsByYear = new Map<number, typeof allPosts>();
allPosts.forEach(post => {
  const year = post.data.date.getFullYear();
  if (!postsByYear.has(year)) postsByYear.set(year, []);
  postsByYear.get(year)!.push(post);
});

const years = [...postsByYear.keys()].sort((a, b) => b - a);
---

<BaseLayout title="Archives">
  <div class="max-w-4xl mx-auto px-4 py-12 md:py-16">
    <h1 class="text-3xl font-serif font-black tracking-tight mb-10" style="color: var(--text-primary);">Archives</h1>
    <div class="space-y-12">
      {years.map(year => (
        <section>
          <h2 class="font-mono text-lg tracking-wider mb-6 flex items-center gap-3" style="color: var(--accent);">
            {year}
            <span class="text-xs font-normal" style="color: var(--text-muted);">{postsByYear.get(year)!.length} posts</span>
          </h2>
          <ul class="space-y-3 border-l-2 pl-6" style="border-color: var(--accent);">
            {postsByYear.get(year)!.map(post => (
              <li class="relative">
                <div class="absolute -left-[1.625rem] top-1.5 w-3 h-3 rounded-full border-2" style="background-color: var(--accent); border-color: var(--bg-primary);"></div>
                <a href={`/${post.data.section}/${getPostSlug(post)}/`} class="group block">
                  <span class="font-mono text-xs tracking-wider" style="color: var(--text-muted);">
                    {post.data.date.toLocaleDateString('ko-KR', { month: 'short', day: 'numeric' })}
                  </span>
                  <span class="ml-3 font-serif hover-underline" style="color: var(--text-primary);">
                    {post.data.title}
                  </span>
                </a>
              </li>
            ))}
          </ul>
        </section>
      ))}
    </div>
  </div>
</BaseLayout>
